<!DOCTYPE html>
<!-- Adicionando a classe 'dark' aqui dinamicamente via JS -->
<html lang="pt-BR" style="color-scheme: light;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Desempenho - Multi-Setores</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons para os ícones -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        /* Estilo base para o dark mode */
        .dark { color-scheme: dark; }

        canvas { max-height: 300px; }
        
        /* --- Estilos das Abas --- */
        .tab-button { 
            transition: all 0.2s ease-in-out; 
            border-bottom: 3px solid transparent; 
            padding-bottom: 8px;
        }
        .tab-button.active { 
            border-color: #4338ca; /* indigo-700 */
            color: #4338ca; /* indigo-700 */
            font-weight: 600; 
        }
        .dark .tab-button.active {
            border-color: #a5b4fc; /* indigo-300 */
            color: #a5b4fc; /* indigo-300 */
        }
        
        /* --- Estilos das Sub-Abas --- */
        .sub-tab-button { 
            transition: all 0.2s ease-in-out; 
            border-bottom: 2px solid transparent; 
        }
        .sub-tab-button.active { 
            border-color: #f59e0b; /* amber-500 */
            color: #f59e0b; /* amber-500 */
            font-weight: 600; 
        }
        .dark .sub-tab-button.active {
             border-color: #fcd34d; /* amber-300 */
            color: #fcd34d; /* amber-300 */
        }
        
        /* --- Estilos do Colapsável --- */
        .collapsible-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out; 
        }
        .collapsible-content.expanded { max-height: 1000px; } /* Aumentado para comportar tabelas */
        
        .lucide-chevron-down { transition: transform 0.3s ease-in-out; }
        .lucide-chevron-down.rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- CABEÇALHO PROFISSIONAL STICKY -->
    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-8 py-3 flex justify-between items-center">
            <!-- Título do Painel na Nav -->
            <div class="flex items-center space-x-3">
                <div data-lucide="bar-chart-3" class="text-indigo-600 dark:text-indigo-400 w-7 h-7"></div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100 hidden sm:block">Painel de Desempenho</h1>
            </div>
            
            <!-- Botão de Alternar Tema (Dark/Light) -->
            <button id="theme-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Alternar tema">
                <span id="theme-icon-light" class="hidden"><div data-lucide="sun" class="w-5 h-5"></div></span>
                <span id="theme-icon-dark"><div data-lucide="moon" class="w-5 h-5"></div></span>
            </button>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <div class="max-w-7xl mx-auto p-4 sm:p-8">
        <header class="mb-8 text-center">
            <h1 id="painel-title" class="text-3xl sm:text-4xl font-bold text-indigo-700 dark:text-indigo-400">Carregando Painel...</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Visualização de processos e desempenho da equipe</p>
            <div id="status-message" class="mt-4 text-sm font-medium"></div>
        </header>

        <!-- Abas Principais -->
        <div class="flex justify-center space-x-4 mb-8 overflow-x-auto pb-2">
            <button id="tab-medica" class="tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg active whitespace-nowrap">Assistência Médica</button>
            <button id="tab-licitacao" class="tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg whitespace-nowrap">Licitação e Contratos</button>
            <button id="tab-previdencia" class="tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg whitespace-nowrap">Previdência</button>
            <button id="tab-contencioso" class="tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg whitespace-nowrap">Contencioso</button>
        </div>
        
        <!-- Nota Global Sobre a Troca de Sistema -->
        <div id="global-system-note" class="flex items-start sm:items-center p-4 mb-8 bg-blue-100 dark:bg-blue-900/50 rounded-lg shadow-md space-x-4 hidden">
            <div data-lucide="info" class="text-blue-600 dark:text-blue-400 flex-shrink-0 w-6 h-6 mt-1 sm:mt-0"></div>
            <p class="text-sm text-blue-800 dark:text-blue-200 font-semibold">
                <b>Nota Importante:</b> A partir de Setembro de 2025, iniciou-se a migração de sistemas do EL para o SEI. Isto pode impactar temporariamente os tempos médios de processo e os registos de desempenho.
            </p>
        </div>

        <!-- Containers de Conteúdo -->
        <div id="loading-container" class="text-center p-10"><p class="text-2xl animate-pulse text-indigo-600 dark:text-indigo-400">Buscando dados das planilhas...</p></div>
        <div id="dashboard-container" class="hidden"></div>
    </div>

    <script>
        // --- URL DA API DO GOOGLE APPS SCRIPT ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzEd3o3JKAreEWhUjBwWghXf_QRfMtlVOEKXP4R15F26bU7Cjmnvs6flsvPLapYr2lA/exec";

        let dashboardsData = {};
        let chartInstances = {};

        // --- LÓGICA DO TEMA (DARK MODE) ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const docHtml = document.documentElement;

        // Função para aplicar o tema (luz ou escuro)
        function applyTheme(theme) {
            if (theme === 'dark') {
                docHtml.classList.add('dark');
                docHtml.style.colorScheme = 'dark';
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            } else {
                docHtml.classList.remove('dark');
                docHtml.style.colorScheme = 'light';
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            }
            // Atualiza as cores dos gráficos
            updateChartColors();
        }

        // Verifica o tema salvo no localStorage ou preferência do sistema
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }

        // Listener para o botão de alternar tema
        themeToggle.addEventListener('click', () => {
            const currentTheme = docHtml.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        // Renderiza ícones estáticos da nav
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // --- DADOS MANUAIS ---
        // (Sem alterações, omitido para economizar espaço no diff)
        // ...
        // --- DADOS MANUAIS ---
        // EDITE AS INFORMAÇÕES DE AUSÊNCIAS E NOTAS AQUI
        const manualData = {
            medica: {
                title: 'Painel de Desempenho da Divisão de Assistência Médica',
                ausencias: [
                    { servidor: 'Nélio', motivo: 'Férias', inicio: '10/07/2025', fim: '07/09/2025' },
                    { servidor: 'Luci', motivo: 'Férias', inicio: '22/09/2025', fim: '01/10/2025' },
                    { servidor: '', motivo: '', inicio: '', fim: '' } // Linha em branco para preenchimento
                ]
            },
            licitacao: {
                title: 'Painel de Desempenho da Divisão de Licitação e Contratos',
                priorityNote: "Os últimos 5 processos realizados em julho foram tratados com prioridade por determinação da presidência. Isso impactou o cronograma dos demais processos que estavam na fila de análise.",
                ausencias: [
                    { servidor: '', motivo: '', inicio: '', fim: '' } // Linha em branco
                ]
            },
            previdencia: { 
                title: 'Painel de Desempenho da Divisão de Processos Previdenciários',
                ausencias: [
                    { servidor: 'Ilza', motivo: 'Viagem a trabalho', inicio: '28/07/2025', fim: '01/08/2025' },
                    { servidor: 'Ilza', motivo: 'Férias', inicio: '01/07/2025', fim: '16/07/2025' }
                ]
            },
            contencioso: {
                title: 'Painel de Desempenho da Divisão Administrativa e Contenciosa',
                ausencias: [
                    { servidor: 'Denise', motivo: 'Congresso agendado', inicio: '05/08/2025', fim: '07/08/2025' }
                ],
                // Dados específicos do Contencioso (RPVs, Precatórios, etc.)
                assistenciaJudicial: {
                    total: 36,
                    demandsList: [
                        { description: 'Cirurgia cardíaca', value: 150000, process: '7017622-10.2025.822.0001' },
                        { description: 'Isenção por acidente de trabalho', value: 62469.64, process: '7041996-90.2025.822.0001' },
                        { description: 'Tratamento de quimioterapia', value: 202298.12, process: '7043114-04.2025.822.0001' },
                    ],
                    details: `<p>Entre <b>janeiro</b> e <b>julho de 2025</b>, o IPAM registrou a citação em <b>36 novas demandas judiciais</b>.</p><h4 class="text-md font-semibold mt-4 mb-2">Assuntos mais demandados:</h4><ul class="list-disc list-inside space-y-1"><li><b>Assistência à Saúde:</b><ul class="list-circle list-inside ml-4"><li>Negativa de cobertura.</li><li>Isenção do elemento moderador decorrente de acidente de trabalho.</li></ul></li><li><b>Previdência:</b><ul class="list-circle list-inside ml-4"><li>Isenção de Imposto de Renda.</li><li>Aposentadoria por invalidez.</li></ul></li></ul>`
                },
                precatorios: {
                    total2025: { value: 270657.56, count: 4 },
                    total2026: { value: 446790.57, count: 4 },
                    total2027: { value: 1816722.02, count: 43 },
                    list2025: [{ ref: '0807728-70.2023.822.0000', fund: 'Previdenciário' },{ ref: '0812024-38.2023.822.0000', fund: 'Assistencial' },{ ref: '0804715-28.2024.822.0001', fund: 'Previdenciário' },{ ref: '0804714-44.2024.822.0000', fund: 'Previdenciário' }],
                    list2026: [{ ref: '0807072-79.2024.822.0000', fund: 'Previdenciário' },{ ref: '0811649-03.2024.822.0000', fund: 'Previdenciário' },{ ref: '0800212-28.2025.822.0000', fund: 'Previdenciário' },{ ref: '0802187-75.2025.822.0000', fund: 'Previdenciário' }],
                    list2027: [{ ref: 'Ação coletiva n. 0014768-22.2012.822.0001', fund: 'Assistência', details: 'Possui 52 beneficiários e um valor total de R$ 2.255.327,48' }],
                    prognostico: [{ process: '0005007-30.2013.822.0001', nature: 'Ação coletiva com 55 beneficiários', value: 2781854.13, fund: 'Assistência', previsao: '2027' },{ process: '7026059-79.2021.822.0001', nature: 'Processo com 8 beneficiários que não renunciaram ao excedente para RPV', value: 151292.08, fund: 'Previdenciário', previsao: '2027' },{ process: '7007321-43.2021.822.0001', nature: '', value: 50810.61, fund: 'Previdenciário', previsao: 'Futuro (a ser definido)' }],
                    regras: { cnj: 'Resolução CNJ nº 303', detalhes: ['Ofícios expedidos <b>até 02 de abril</b>: A inscrição do precatório ocorrerá no ano seguinte ao da expedição.','Ofícios expedidos <b>após 02 de abril</b>: A inscrição do precatório ocorrerá no segundo ano subsequente à expedição.'] }
                },
                rpvs: {
                    totalPaid: { count: 295, value: 2379042.23 },
                    pending: { count: 1, value: 135906.23, process: '7026059-79.2021.822.0001', motivo: 'Inconsistência dos dados dos Beneficiários', status: 'Aguardando ordem judicial para inscrição' }
                }
            }
        };


        // --- FUNÇÕES AUXILIARES DE GRÁFICOS ---
        
        // Retorna as cores corretas para os gráficos com base no tema
        function getChartThemeColors() {
            const isDark = document.documentElement.classList.contains('dark');
            return {
                ticksColor: isDark ? 'rgb(209 213 219)' : 'rgb(107 114 128)', // gray-300 / gray-500
                gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                legendColor: isDark ? 'rgb(229 231 235)' : 'rgb(55 65 81)', // gray-200 / gray-700
            };
        }

        // Atualiza as cores de todos os gráficos existentes
        function updateChartColors() {
            const colors = getChartThemeColors();
            Object.values(chartInstances).forEach(chart => {
                if (chart) {
                    if(chart.options.scales.x) {
                        chart.options.scales.x.ticks.color = colors.ticksColor;
                        chart.options.scales.x.grid.color = colors.gridColor;
                    }
                    if(chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = colors.ticksColor;
                        chart.options.scales.y.grid.color = colors.gridColor;
                    }
                    if (chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels.color = colors.legendColor;
                    }
                    chart.update('none'); // 'none' para evitar re-animação
                }
            });
        }

        function createChart(id, type, data, options) {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (!ctx) return;
            
            const colors = getChartThemeColors();
            
            // Opções padrão do tema para todos os gráficos
            const themeOptions = {
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { color: colors.ticksColor }, 
                        grid: { color: colors.gridColor, drawBorder: false }
                    },
                    x: { 
                        ticks: { color: colors.ticksColor }, 
                        grid: { color: colors.gridColor, drawBorder: false } 
                    }
                },
                plugins: {
                    legend: { 
                        labels: { color: colors.legendColor } 
                    }
                }
            };

            // Mescla opções padrão com opções específicas do gráfico
            const finalOptions = { ...themeOptions, ...options };
            finalOptions.scales = { ...themeOptions.scales, ...(options.scales || {}) };
            finalOptions.scales.x = { ...themeOptions.scales.x, ...(options.scales?.x || {}) };
            finalOptions.scales.y = { ...themeOptions.scales.y, ...(options.scales?.y || {}) };
            finalOptions.plugins = { ...themeOptions.plugins, ...(options.plugins || {}) };
            if (options.plugins?.legend) {
                 finalOptions.plugins.legend = { ...themeOptions.plugins.legend, ...options.plugins.legend };
            }

            if (chartInstances[id]) chartInstances[id].destroy();
            chartInstances[id] = new Chart(ctx, { type, data, options: finalOptions });
        }


        // --- FUNÇÕES AUXILIARES DE UI ---

        function toggleCollapsible(id) {
            const element = document.getElementById(id);
            const chevron = element.previousElementSibling.querySelector('.lucide-chevron-down');
            element.classList.toggle('expanded');
            if (chevron) chevron.classList.toggle('rotate-180');
        }

        function setActiveSubTabButtons(activeId) {
            document.querySelectorAll('.sub-tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(activeId).classList.add('active');
        }

        /**
         * NOVO: Cria um card de KPI profissional.
         */
        function createKpiCard(title, value, iconName, iconColor, iconBgColor, subtitle = '') {
            const subtitleHtml = subtitle ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${subtitle}</p>` : '';
            // Ajustando a cor de fundo do ícone no dark mode
            const darkIconBgColor = iconBgColor.replace('100', '900'); 
            const darkIconColor = iconColor.replace('600', '400');

            return `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">${title}</h3>
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${value}</p>
                        ${subtitleHtml}
                    </div>
                    <div class="flex-shrink-0 p-3 rounded-full ${iconBgColor} dark:bg-opacity-30 dark:${darkIconBgColor}">
                        <div data-lucide="${iconName}" class="${iconColor} dark:${darkIconColor} w-6 h-6"></div>
                    </div>
                </div>
            </div>`;
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderStandardDashboard(data, containerId) {
            const container = document.getElementById(containerId);
            if (!data || !data.kpis || data.kpis.concluidos === null) {
                container.innerHTML = `<div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg text-center text-gray-500 dark:text-gray-400"><p class="font-semibold">Dados de desempenho para este setor ainda não foram configurados na planilha.</p><p class="text-sm mt-2">Por favor, configure o ID e os intervalos de células no Google Apps Script para automatizar esta visualização.</p></div>`;
                return;
            }
            const { kpis, graficoMensal, desempenhoEquipe, ausencias } = data;
            const totalGeral = (kpis.concluidos || 0) + (kpis.emAndamento || 0);

            const totalProcessosTitle = (data.graficoJudicial) ? 'Total de Processos Administrativos' : 'Total de Processos';

            // ATUALIZADO: Usando a nova função createKpiCard
            let kpiCardsHtml = 
                createKpiCard('Concluídos', kpis.concluidos, 'check-circle', 'text-green-600', 'bg-green-100') +
                createKpiCard('Em Andamento', kpis.emAndamento, 'clock', 'text-yellow-600', 'bg-yellow-100') +
                createKpiCard(totalProcessosTitle, totalGeral, 'briefcase', 'text-blue-600', 'bg-blue-100') +
                createKpiCard('Média Duração', `${kpis.mediaDuracao} dias`, 'calendar-clock', 'text-purple-600', 'bg-purple-100');

            let gridClass = 'lg:grid-cols-4';

            if (data.graficoJudicial && data.graficoJudicial.data?.length > 0) {
                const totalDemandas = data.graficoJudicial.data.reduce((sum, value) => sum + (Number(value) || 0), 0);
                kpiCardsHtml += createKpiCard('Total Demandas Jud.', totalDemandas, 'gavel', 'text-red-600', 'bg-red-100');
                gridClass = 'lg:grid-cols-5';
            }

            const kpisHtml = `<div class="grid grid-cols-1 sm:grid-cols-2 ${gridClass} gap-6 mb-8">
                ${kpiCardsHtml}
            </div>`;
            
            const priorityNoteHtml = data.priorityNote ? `<div class="flex items-start sm:items-center p-4 mb-8 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg shadow-md space-x-4"><div data-lucide="alert-triangle" class="text-yellow-600 dark:text-yellow-400 flex-shrink-0 w-6 h-6 mt-1 sm:mt-0"></div><p class="text-sm text-yellow-800 dark:text-yellow-200 font-semibold">${data.priorityNote}</p></div>` : '';
            
            // ATUALIZADO: Adicionando classes de dark mode e novos estilos de card
            const chartsAndTablesHtml = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Processos por Mês</h3><canvas id="monthlyChart"></canvas></div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Desempenho da Equipe</h3><canvas id="employeeChart"></canvas></div>
                </div>

                <div id="judicial-chart-container" class="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hidden">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Demandas Judiciais por Tema</h3>
                    <canvas id="judicialChart" style="max-height: 350px;"></canvas>
                </div>

                <div class="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Resumo por Servidor</h3><div class="overflow-x-auto"><table class="w-full table-auto text-sm">
                    <thead class="bg-gray-100 dark:bg-gray-700/50 text-left">
                        <tr>
                            <th class="p-3 font-semibold">Servidor</th>
                            <th class="p-3 font-semibold">Encaminhados</th>
                            <th class="p-3 font-semibold">Concluídos</th>
                            <th class="p-3 font-semibold">Em Andamento</th>
                            <th class="p-3 font-semibold">Média Duração (dias)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${desempenhoEquipe.map(e => `<tr class="border-b dark:border-gray-700 last:border-b-0"><td class="p-3">${e.name}</td><td class="p-3">${e.sent}</td><td class="p-3">${e.completed}</td><td class="p-3">${e.inProgress}</td><td class="p-3">${e.avgDuration}</td></tr>`).join('')}
                    </tbody>
                </table></div></div>`;
            
            const ausenciasHtml = (ausencias && ausencias.filter(a => a.servidor).length > 0) ? `
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Férias e Ausências Programadas</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto text-sm">
                            <thead class="bg-gray-100 dark:bg-gray-700/50 text-left">
                                <tr>
                                    <th class="p-3 font-semibold">Servidor</th>
                                    <th class="p-3 font-semibold">Motivo</th>
                                    <th class="p-3 font-semibold">Período</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ausencias.filter(a => a.servidor).map(a => `<tr class="border-b dark:border-gray-700 last:border-b-0"><td class="p-3">${a.servidor}</td><td class="p-3">${a.motivo}</td><td class="p-3">${a.inicio} - ${a.fim}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>` : '';

            container.innerHTML = kpisHtml + priorityNoteHtml + chartsAndTablesHtml + ausenciasHtml;
            
            // --- Criação dos Gráficos ---

            if (graficoMensal?.labels?.length > 0) {
                const corNormal = '#8b5cf6'; // violet-500
                const corDestaque = '#f59e0b'; // amber-500
                const coresGraficoMensal = graficoMensal.labels.map(label => {
                    return label.toLowerCase().includes('set') ? corDestaque : corNormal;
                });

                createChart('monthlyChart', 'bar', { 
                    labels: graficoMensal.labels, 
                    datasets: [{ 
                        label: 'Processos', 
                        data: graficoMensal.data.map(d => Number(d) || 0), 
                        backgroundColor: coresGraficoMensal,
                        borderRadius: 5 
                    }] 
                }, { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { display: false }
                    } 
                });
            }

            if (desempenhoEquipe?.length > 0) {
                createChart('employeeChart', 'bar', { 
                    labels: desempenhoEquipe.map(e => e.name), 
                    datasets: [
                        { label: 'Encaminhados', data: desempenhoEquipe.map(e => Number(e.sent) || 0), backgroundColor: '#3b82f6', stack: 'a', borderRadius: 5 }, 
                        { label: 'Concluídos', data: desempenhoEquipe.map(e => Number(e.completed) || 0), backgroundColor: '#10b981', stack: 'a', borderRadius: 5 }, 
                        { label: 'Em Andamento', data: desempenhoEquipe.map(e => Number(e.inProgress) || 0), backgroundColor: '#f59e0b', stack: 'a', borderRadius: 5 }
                    ] 
                }, { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: {
                        legend: { 
                            position: 'top'
                        } 
                    } 
                });
            }

            if (data.graficoJudicial?.labels?.length > 0) {
                const judicialContainer = document.getElementById('judicial-chart-container');
                if (judicialContainer) judicialContainer.classList.remove('hidden');

                createChart('judicialChart', 'bar', { 
                    labels: data.graficoJudicial.labels, 
                    datasets: [{ 
                        label: 'Demandas', 
                        data: data.graficoJudicial.data.map(d => Number(d) || 0), 
                        backgroundColor: '#8b5cf6',
                        borderRadius: 5 
                    }] 
                }, { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }
                    }
                });
            }
        }

        function renderContenciosoDashboard(data) {
             const container = document.getElementById('dashboard-container');
             container.innerHTML = `
                <div class="flex justify-center space-x-4 mb-8 overflow-x-auto pb-2">
                    <button id="sub-tab-precatorios" class="sub-tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg active whitespace-nowrap">Precatórios</button>
                    <button id="sub-tab-rpvs" class="sub-tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg whitespace-nowrap">RPVs</button>
                    <button id="sub-tab-desempenho" class="sub-tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg whitespace-nowrap">Desempenho Geral</button>
                    <button id="sub-tab-assistencia-judicial" class="sub-tab-button px-4 py-2 text-lg text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-100 rounded-t-lg whitespace-nowrap">Demandas da Assistência Médica</button>
                </div>
                <div id="contencioso-content"></div>`;
            
            document.getElementById('sub-tab-precatorios').addEventListener('click', () => { renderPrecatorios(data.precatorios); setActiveSubTabButtons('sub-tab-precatorios'); });
            document.getElementById('sub-tab-rpvs').addEventListener('click', () => { renderRPVs(data.rpvs); setActiveSubTabButtons('sub-tab-rpvs'); });
            document.getElementById('sub-tab-desempenho').addEventListener('click', () => { renderStandardDashboard(data, 'contencioso-content'); setActiveSubTabButtons('sub-tab-desempenho'); });
            document.getElementById('sub-tab-assistencia-judicial').addEventListener('click', () => { renderAssistenciaJudicial(data.assistenciaJudicial); setActiveSubTabButtons('sub-tab-assistencia-judicial'); });

            renderPrecatorios(data.precatorios);
        }

        function renderPrecatorios(d) {
            const content = document.getElementById('contencioso-content');
            if (!content) return;
            const formatCurrency = (val) => `R$ ${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

            content.innerHTML = `
                <!-- ATUALIZADO: KPIs de Precatórios -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                     ${createKpiCard('Precatórios 2025', d.total2025.count, 'calendar-check', 'text-green-600', 'bg-green-100', formatCurrency(d.total2025.value))}
                     ${createKpiCard('Precatórios 2026', d.total2026.count, 'calendar-plus', 'text-blue-600', 'bg-blue-100', formatCurrency(d.total2026.value))}
                     ${createKpiCard('Precatórios 2027', d.total2027.count, 'calendar-x', 'text-purple-600', 'bg-purple-100', formatCurrency(d.total2027.value))}
                </div>
                <!-- Seções Colapsáveis -->
                <div class="space-y-4">
                    ${createCollapsibleSection('precatorios-2025', 'Detalhes dos Precatórios 2025', createTableHtml(['Referência', 'Fundo'], d.list2025))}
                    ${createCollapsibleSection('precatorios-2026', 'Detalhes dos Precatórios 2026', createTableHtml(['Referência', 'Fundo'], d.list2026))}
                    ${createCollapsibleSection('precatorios-prognostico', 'Prognóstico de Novas Inscrições', createTableHtml(['Processo', 'Natureza', 'Valor', 'Fundo', 'Previsão'], d.prognostico, true))}
                    ${createCollapsibleSection('precatorios-regras', 'Regras de Pagamento de Precatórios', `<div class="prose max-w-none prose-sm sm:prose-base dark:prose-invert mt-4 text-gray-700 dark:text-gray-300 leading-relaxed"><p class="font-semibold">${d.regras.cnj}</p><ul class="list-disc list-inside space-y-1">${d.regras.detalhes.map(detail => `<li>${detail}</li>`).join('')}</ul></div>`)}
                </div>`;
        }

        function renderRPVs(d) {
            const content = document.getElementById('contencioso-content');
            if(!content) return;
            const formatCurrency = (val) => `R$ ${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            content.innerHTML = `
                <!-- ATUALIZADO: KPIs de RPVs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    ${createKpiCard('RPVs Pagos (2025)', d.totalPaid.count, 'banknote', 'text-green-600', 'bg-green-100', formatCurrency(d.totalPaid.value))}
                    ${createKpiCard('RPVs Pendentes (2025)', d.pending.count, 'alert-triangle', 'text-red-600', 'bg-red-100', formatCurrency(d.pending.value))}
                </div>
                <!-- ATUALIZADO: Card de Detalhes -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Detalhes do RPV Pendente</h3><div class="prose prose-sm sm:prose-base max-w-none text-gray-700 dark:text-gray-300 dark:prose-invert"><p><b>Referência:</b> ${d.pending.process}</p><p><b>Motivo:</b> ${d.pending.motivo}</p><p><b>Status:</b> ${d.pending.status}</p></div></div>`;
        }
        
        function renderAssistenciaJudicial(d) {
            const content = document.getElementById('contencioso-content');
            if(!content) return;
            const totalValue = d.demandsList.reduce((sum, item) => sum + item.value, 0);
            const formatCurrency = (val) => `R$ ${val.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- ATUALIZADO: Card de Risco Total -->
                    ${createKpiCard('Risco Total', formatCurrency(totalValue), 'dollar-sign', 'text-red-600', 'bg-red-100')}
                    
                    <!-- ATUALIZADO: Card Colapsável -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 lg:col-span-2">
                        <button class="flex items-center justify-between w-full text-left" onclick="toggleCollapsible('judicial-demands-details')">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Novas Demandas Judiciais</h3>
                            <div class="flex items-center space-x-2"><span class="text-3xl font-bold text-purple-500">${d.total}</span><div data-lucide="chevron-down" class="lucide-chevron-down text-purple-500"></div></div>
                        </button>
                        <div id="judicial-demands-details" class="collapsible-content"><div class="prose prose-sm sm:prose-base max-w-none mt-4 text-gray-700 dark:text-gray-300 dark:prose-invert leading-relaxed">${d.details}</div></div>
                    </div>
                </div>
                <!-- ATUALIZADO: Tabela de Débitos -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Débitos Judiciais Confirmados</h3>${createTableHtml(['Descrição', 'Valor', 'Processo'], d.demandsList, true)}</div>`;
        }

        // ATUALIZADO: Função para criar seções colapsáveis
        function createCollapsibleSection(id, title, content) {
            return `<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <button class="flex items-center justify-between w-full text-left" onclick="toggleCollapsible('${id}')">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">${title}</h3>
                            <div data-lucide="chevron-down" class="lucide-chevron-down text-gray-500"></div>
                        </button>
                        <div id="${id}" class="collapsible-content">${content}</div>
                    </div>`;
        }

        // ATUALIZADO: Função para criar tabelas dinamicamente
        function createTableHtml(headers, rows, formatValueAsCurrency = false) {
            const headerHtml = headers.map(h => `<th class="p-3 font-semibold">${h}</th>`).join('');
            const bodyHtml = rows.map(row => {
                const cells = Object.values(row).map((cell, index) => {
                    const header = headers[index] ? headers[index].toLowerCase() : '';
                    if (formatValueAsCurrency && header === 'valor') {
                        return `<td class="p-3">R$ ${Number(cell).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                    }
                    return `<td class="p-3">${cell}</td>`;
                }).join('');
                return `<tr class="border-b border-gray-200 dark:border-gray-700 last:border-b-0">${cells}</tr>`;
            }).join('');
            return `<div class="overflow-x-auto mt-4"><table class="w-full table-auto text-sm"><thead class="bg-gray-100 dark:bg-gray-700/50 text-left"><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table></div>`;
        }
        
        function renderDashboard(sector) {
            const data = dashboardsData[sector];
            document.getElementById('painel-title').textContent = data.title;
            if (sector === 'contencioso') {
                renderContenciosoDashboard(data);
            } else {
                renderStandardDashboard(data, 'dashboard-container');
            }
            // Re-renderiza os ícones do Lucide
            setTimeout(() => { if (typeof lucide !== 'undefined' && lucide.createIcons) { lucide.createIcons(); } }, 50);
        }

        // --- INICIALIZAÇÃO E LÓGICA PRINCIPAL ---
        async function init() {
            const loadingContainer = document.getElementById('loading-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            const statusMessage = document.getElementById('status-message');
            const globalNote = document.getElementById('global-system-note');
            
            if (API_URL === "COLE_A_SUA_URL_AQUI" || !API_URL) {
                loadingContainer.innerHTML = `<p class="text-2xl text-red-600">ERRO: URL da API não configurada.</p>`;
                return;
            }
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Erro de rede: ${response.status}`);
                let apiData = await response.json();

                if (apiData.error) {
                    console.error("Erro recebido do Google Script:", apiData.error);
                    statusMessage.textContent = `Erro no script da planilha: ${apiData.error}. A exibir apenas dados manuais.`;
                    statusMessage.className = 'mt-4 text-sm font-medium text-red-600 dark:text-red-400';
                    apiData = {};
                } else {
                    statusMessage.textContent = `Dados atualizados em: ${new Date().toLocaleString('pt-BR')}`;
                    statusMessage.className = 'mt-4 text-sm font-medium text-green-600 dark:text-green-400';
                }
                
                dashboardsData.medica = { ...manualData.medica, ...(apiData.dadosPlan1 || {}) };
                dashboardsData.licitacao = { ...manualData.licitacao, ...(apiData.dadosPlan2 || {}) };
                dashboardsData.previdencia = { ...manualData.previdencia, ...(apiData.dadosPlan3 || {}) };
                dashboardsData.contencioso = { ...manualData.contencioso, ...(apiData.dadosPlan4 || {}) };
                
                loadingContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                if (globalNote) globalNote.classList.remove('hidden');
                
                setActiveTab('tab-medica');
                
            } catch (error) {
                loadingContainer.innerHTML = `<p class="text-2xl text-red-600">Falha ao Carregar Dados</p><p class="text-gray-600 dark:text-gray-400 mt-2">${error.message}</p>`;
                if (globalNote) globalNote.classList.remove('hidden');
                console.error("Erro detalhado:", error);
            }
        }

        function setActiveTab(activeId) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(activeId).classList.add('active');
            renderDashboard(activeId.replace('tab-', ''));
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => setActiveTab(e.target.id));
        });
        
        window.addEventListener('load', init);
    </script>
</body>
</html>

